<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Reversible Write Reversion Note 2 - zkEVM (Community Edition) Documentation</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../architecture.html"><strong aria-hidden="true">2.</strong> Circuit Architecture</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../architecture/evm-circuit.html"><strong aria-hidden="true">2.1.</strong> EVM Circuit</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../architecture/evm-circuit/opcode-fetching.html"><strong aria-hidden="true">2.1.1.</strong> Opcode Fetching</a></li><li class="chapter-item expanded "><a href="../architecture/evm-circuit/multi-step.html"><strong aria-hidden="true">2.1.2.</strong> Multi-Step Implementation</a></li></ol></li><li class="chapter-item expanded "><a href="../architecture/tx-circuit.html"><strong aria-hidden="true">2.2.</strong> Tx Circuit</a></li><li class="chapter-item expanded "><a href="../architecture/state-circuit.html"><strong aria-hidden="true">2.3.</strong> State Circuit</a></li><li class="chapter-item expanded "><a href="../architecture/bytecode-circuit.html"><strong aria-hidden="true">2.4.</strong> Bytecode Circuit</a></li><li class="chapter-item expanded "><a href="../architecture/ecdsa-circuit.html"><strong aria-hidden="true">2.5.</strong> ECDSA Circuit</a></li><li class="chapter-item expanded "><a href="../architecture/keccak-circuit.html"><strong aria-hidden="true">2.6.</strong> Keccak Circuit</a></li><li class="chapter-item expanded "><a href="../architecture/mpt-circuit.html"><strong aria-hidden="true">2.7.</strong> Merkle Patricia Tree Circuit</a></li></ol></li><li class="chapter-item expanded "><a href="../design.html"><strong aria-hidden="true">3.</strong> Design Notes</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../design/random-linear-combinaion.html"><strong aria-hidden="true">3.1.</strong> Random Linear Combination</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../design/random-linear-combinaion/full-runnable-code.html"><strong aria-hidden="true">3.1.1.</strong> Full Runnable Code</a></li></ol></li><li class="chapter-item expanded "><a href="../design/recursion.html"><strong aria-hidden="true">3.2.</strong> Recursion</a></li><li class="chapter-item expanded "><a href="../design/reversible-write-reversion.html"><strong aria-hidden="true">3.3.</strong> Reversible Write Reversion Note 1</a></li><li class="chapter-item expanded "><a href="../design/reversible-write-reversion2.html" class="active"><strong aria-hidden="true">3.4.</strong> Reversible Write Reversion Note 2</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">zkEVM (Community Edition) Documentation</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="reversible-write-reversion-note-2"><a class="header" href="#reversible-write-reversion-note-2">Reversible Write Reversion Note 2</a></h1>
<h1 id="zkevm---state-circuit-extension---statedb"><a class="header" href="#zkevm---state-circuit-extension---statedb">ZKEVM - State Circuit Extension - <code>StateDB</code></a></h1>
<h2 id="reversion"><a class="header" href="#reversion">Reversion</a></h2>
<p>In EVM, there are multiple kinds of <code>StateDB</code> updates that could be reverted when any internal call fails.</p>
<ul>
<li><code>tx_access_list_account</code> - <code>(tx_id, address) -&gt; accessed</code></li>
<li><code>tx_access_list_storage_slot</code> - <code>(tx_id, address, storage_slot) -&gt; accessed</code></li>
<li><code>account_nonce</code> - <code>address -&gt; nonce</code></li>
<li><code>account_balance</code> - <code>address -&gt; balance</code></li>
<li><code>account_code_hash</code> - <code>address -&gt; code_hash</code></li>
<li><code>account_storage</code> - <code>(address, storage_slot) -&gt; storage</code></li>
</ul>
<p>The complete list can be found <a href="https://github.com/ethereum/go-ethereum/blob/master/core/state/journal.go#L87-L141">here</a>.  For <code>tx_refund</code>, <code>tx_log</code>, <code>account_destructed</code> we don't need to write and revert because those state changes don't affect future execution, so we only write them when <code>is_persistent=1</code>.</p>
<h3 id="visualization"><a class="header" href="#visualization">Visualization</a></h3>
<p><img src="./state-write-reversion2_call-depth.png" alt="" /></p>
<ul>
<li>Black arrow represents the time, which is composed by points of sequential <code>rw_counter</code>.</li>
<li>Red circle represents the revert section.</li>
</ul>
<p>The actions that write to the <code>StateDB</code> inside the red box will also revert themselves in the revert section (red circle), but in reverse order.</p>
<p>Each call needs to know its <code>rw_counter_end_of_revert_section</code> to revert with the correct <code>rw_counter</code>. If callee is a success call but in some red box (<code>is_persistent=0</code>), we need to copy caller's <code>rw_counter_end_of_revert_section</code> and <code>reversible_write_counter</code> to callee's.</p>
<h2 id="selfdestruct"><a class="header" href="#selfdestruct"><code>SELFDESTRUCT</code></a></h2>
<p>The opcode <code>SELFDESTRUCT</code> sets the flag <code>is_destructed</code> of the account, but before that transaction ends, the account can still be executed, receive ether, and access storage as usual. The flag <code>is_destructed</code> takes effect only after a transaction ends.</p>
<p>In particular, the state trie gets finalized after each transaction, and only when state trie gets finalized the account is actually deleted. After the transaction with <code>SELFDESTRUCT</code> is finalized, any further transaction treats the account as an empty account.</p>
<blockquote>
<p>So if some contract executed <code>SELFDESTRUCT</code> but then receive some ether, those ether will vanish into thin air after the transaction is finalized. Soooo weird.</p>
<p><strong>han</strong></p>
</blockquote>
<p>The <code>SELFDESTRUCT</code> is a powerful opcode that makes many state changes at the same time including:</p>
<ul>
<li><code>account_nonce</code></li>
<li><code>account_balance</code></li>
<li><code>account_code_hash</code></li>
<li>all slots of <code>account_storage</code></li>
</ul>
<p>The first 3 values are relatively easy to handle in circuit: we could track an extra <code>selfdestruct_counter</code> and <code>rw_counter_end_of_tx</code> and set them to empty value at <code>rw_counter_end_of_tx - selfdestruct_counter</code>, which is just how we handle reverts.</p>
<p>However, the <code>account_storage</code> is tricky because we don't track the storage trie and update it after each transaction, instead we only track each used slot in storage trie and update the storage trie after the whole block.</p>
<h3 id="workaround-for-consistency-check"><a class="header" href="#workaround-for-consistency-check">Workaround for consistency check</a></h3>
<p>It seems that we need to annotate each account with a <code>revision_id</code>. The <code>revision_id</code> increases only when <code>is_destructed</code> is set and <code>tx_id</code> changes. With the different <code>revision_id</code>s we can reset the values in State circuit for <code>nonce</code>, <code>balance</code>, <code>code_hash</code>, and each <code>storage</code> just like we initialize the memroy.</p>
<p>So <code>address -&gt; is_destructed</code> becomes <code>(tx_id, address) -&gt; (revision_id, is_destructed)</code>.</p>
<p>Then we add an extra <code>revision_id</code> to <code>nonce</code>, <code>balance</code>, <code>code_hash</code> and <code>storage</code>. For <code>nonce</code>, <code>balance</code> and <code>code_hash</code> we group them by <code>(address, revision_id) -&gt; {nonce,balance,code_hash}</code>, for <code>storage</code> we group them by <code>(address, storage_slot, revision_id) -&gt; storage_value</code>.</p>
<p>Here is an example of <code>account_balance</code> with <code>revision_id</code>:</p>
<p>$$
\begin{array}{|c|c|}
\hline
\texttt{address} &amp; \texttt{revision_id} &amp; \texttt{rwc} &amp; \texttt{balance} &amp; \texttt{balance_prev} &amp; \texttt{is_write} &amp; \text{note} \\\hline
\color{#aaa}{\texttt{0xfd}} &amp; \color{#aaa}{\texttt{-}} &amp; \color{#aaa}{\texttt{-}} &amp; \color{#aaa}{\texttt{-}} &amp; \color{#aaa}{\texttt{-}} &amp; \color{#aaa}{\texttt{-}} \\\hline
\texttt{0xfe} &amp; \texttt{1} &amp; \color{#aaa}{\texttt{x}} &amp; \texttt{10} &amp; \color{#aaa}{\texttt{x}} &amp; \texttt{1} &amp; \text{open from trie} \\\hline
\texttt{0xfe} &amp; \texttt{1} &amp; \texttt{23} &amp; \texttt{20} &amp; \texttt{10} &amp; \texttt{1} \\\hline
\texttt{0xfe} &amp; \texttt{1} &amp; \texttt{45} &amp; \texttt{20} &amp; \texttt{20} &amp; \texttt{0} \\\hline
\texttt{0xfe} &amp; \texttt{1} &amp; \texttt{60} &amp; \texttt{0} &amp; \texttt{20} &amp; \texttt{1} \\\hline
\texttt{0xfe} &amp; \color{#f00}{\texttt{1}} &amp; \texttt{63} &amp; \texttt{5} &amp; \texttt{0} &amp; \texttt{1} \\\hline
\texttt{0xfe} &amp; \color{#f00}{\texttt{2}} &amp; \color{#aaa}{\texttt{x}} &amp; \color{#f00}{\texttt{0}} &amp; \color{#aaa}{\texttt{x}} &amp; \texttt{1} &amp; \text{reset} \\\hline
\texttt{0xfe} &amp; \texttt{2} &amp; \texttt{72} &amp; \texttt{0} &amp; \texttt{0} &amp; \texttt{0} \\\hline
\color{#aaa}{\texttt{0xff}} &amp; \color{#aaa}{\texttt{-}} &amp; \color{#aaa}{\texttt{-}} &amp; \color{#aaa}{\texttt{-}} &amp; \color{#aaa}{\texttt{-}} &amp; \color{#aaa}{\texttt{-}} \\\hline
\end{array}
$$</p>
<p>Note that after contract selfdestructs, it can still receive ether, but the ether will vanish into thin air after transaction gets finalized. The reset is like the lazy initlization of memory, <strong>the value is set to <code>0</code> when <code>revision_id</code> is different</strong>.</p>
<p>Here is how we increase the <code>revision_id</code>:</p>
<p>$$
\begin{array}{|c|c|}
\hline
\texttt{address} &amp; \texttt{tx_id} &amp; \texttt{rwc} &amp; \texttt{revision_id} &amp; \texttt{is_destructed} &amp; \texttt{is_destructed_prev} &amp; \texttt{is_write} &amp; \text{note} \\\hline
\color{#aaa}{\texttt{0xfd}} &amp; \color{#aaa}{\texttt{-}} &amp; \color{#aaa}{\texttt{-}} &amp; \color{#aaa}{\texttt{-}} &amp; \color{#aaa}{\texttt{-}} &amp; \color{#aaa}{\texttt{-}} &amp; \color{#aaa}{\texttt{-}} \\\hline
\texttt{0xff} &amp; \texttt{1} &amp; \color{#aaa}{\texttt{x}} &amp; \texttt{1} &amp; \texttt{0} &amp; \color{#aaa}{\texttt{x}} &amp; \texttt{1} &amp; \text{init} \\\hline
\texttt{0xff} &amp; \texttt{1} &amp; \texttt{11} &amp; \texttt{1} &amp; \texttt{0} &amp; \texttt{0} &amp; \texttt{0} \\\hline
\texttt{0xff} &amp; \texttt{1} &amp; \texttt{17} &amp; \texttt{1} &amp; \texttt{1} &amp; \texttt{0} &amp; \texttt{1} &amp; \text{self destruct} \\\hline
\texttt{0xff} &amp; \color{#f00}{\texttt{1}} &amp; \texttt{29} &amp; \texttt{1} &amp; \color{#f00}{\texttt{1}} &amp; \texttt{1} &amp; \texttt{1} &amp; \text{self destruct again} \\\hline
\texttt{0xff} &amp; \color{#f00}{\texttt{2}} &amp; \color{#aaa}{\texttt{x}} &amp; \color{#f00}{\texttt{2}} &amp; \texttt{0} &amp; \color{#aaa}{\texttt{x}} &amp; \texttt{1} &amp; \text{increase} \\\hline
\texttt{0xff} &amp; \texttt{2} &amp; \texttt{40} &amp; \texttt{2} &amp; \texttt{0} &amp; \texttt{0} &amp; \texttt{0} \\\hline
\texttt{0xff} &amp; \texttt{3} &amp; \color{#aaa}{\texttt{x}} &amp; \texttt{2} &amp; \texttt{0} &amp; \color{#aaa}{\texttt{x}} &amp; \texttt{1} &amp; \text{no increase} \\\hline
\color{#aaa}{\texttt{0xff}} &amp; \color{#aaa}{\texttt{-}} &amp; \color{#aaa}{\texttt{-}} &amp; \color{#aaa}{\texttt{-}} &amp; \color{#aaa}{\texttt{-}} &amp; \color{#aaa}{\texttt{-}} &amp; \color{#aaa}{\texttt{-}} \\\hline
\end{array}
$$</p>
<p>Because self destruct only takes effect after the transaction, we <strong>increase the <code>revision_id</code> only when <code>tx_id</code> is different and <code>is_destructed</code> is set</strong>.</p>
<h3 id="workaround-for-trie-update"><a class="header" href="#workaround-for-trie-update">Workaround for trie update</a></h3>
<p>The State circuit not only checks consistency, it also triggers the update of the storage tries and state trie.</p>
<p>Originally, some part of State circuit would assign the first row value and collect the last row value of each account's <code>nonce</code>, <code>balance</code>, <code>code_hash</code> as well as the first &amp; last used slots of storage, then update the state trie.</p>
<p>With <code>revision_id</code>, it needs to peek the final <code>revision_id</code> first, and collect the last row value with the <code>revision_id</code> to make sure all values are actually reset.</p>
<h2 id="reference"><a class="header" href="#reference">Reference</a></h2>
<ul>
<li><a href="https://github.com/ethereum/go-ethereum/blob/master/core/state/journal.go"><code>journal.go</code></a></li>
<li><a href="https://hackmd.io/@vbuterin/selfdestruct#SELFDESTRUCT-is-the-only-opcode-that-breaks-important-invariants">Pragmatic destruction of <code>SELFDESTRUCT</code></a></li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../design/reversible-write-reversion.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../design/reversible-write-reversion.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript" src="../mermaid.min.js"></script>
        <script type="text/javascript" src="../mermaid-init.js"></script>
    </body>
</html>
