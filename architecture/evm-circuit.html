<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>EVM Circuit - zkEVM (Community Edition) Documentation</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../architecture.html"><strong aria-hidden="true">2.</strong> Circuit Architecture</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../architecture/evm-circuit.html" class="active"><strong aria-hidden="true">2.1.</strong> EVM Circuit</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../architecture/evm-circuit/opcode-fetching.html"><strong aria-hidden="true">2.1.1.</strong> Opcode Fetching</a></li><li class="chapter-item expanded "><a href="../architecture/evm-circuit/multi-step.html"><strong aria-hidden="true">2.1.2.</strong> Multi-Step Implementation</a></li></ol></li><li class="chapter-item expanded "><a href="../architecture/tx-circuit.html"><strong aria-hidden="true">2.2.</strong> Tx Circuit</a></li><li class="chapter-item expanded "><a href="../architecture/state-circuit.html"><strong aria-hidden="true">2.3.</strong> State Circuit</a></li><li class="chapter-item expanded "><a href="../architecture/bytecode-circuit.html"><strong aria-hidden="true">2.4.</strong> Bytecode Circuit</a></li><li class="chapter-item expanded "><a href="../architecture/ecdsa-circuit.html"><strong aria-hidden="true">2.5.</strong> ECDSA Circuit</a></li><li class="chapter-item expanded "><a href="../architecture/keccak-circuit.html"><strong aria-hidden="true">2.6.</strong> Keccak Circuit</a></li><li class="chapter-item expanded "><a href="../architecture/mpt-circuit.html"><strong aria-hidden="true">2.7.</strong> Merkle Patricia Tree Circuit</a></li></ol></li><li class="chapter-item expanded "><a href="../design.html"><strong aria-hidden="true">3.</strong> Design Notes</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../design/random-linear-combinaion.html"><strong aria-hidden="true">3.1.</strong> Random Linear Combination</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../design/random-linear-combinaion/full-runnable-code.html"><strong aria-hidden="true">3.1.1.</strong> Full Runnable Code</a></li></ol></li><li class="chapter-item expanded "><a href="../design/recursion.html"><strong aria-hidden="true">3.2.</strong> Recursion</a></li><li class="chapter-item expanded "><a href="../design/reversible-write-reversion.html"><strong aria-hidden="true">3.3.</strong> Reversible Write Reversion Note 1</a></li><li class="chapter-item expanded "><a href="../design/reversible-write-reversion2.html"><strong aria-hidden="true">3.4.</strong> Reversible Write Reversion Note 2</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">zkEVM (Community Edition) Documentation</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="evm-circuit"><a class="header" href="#evm-circuit">EVM Circuit</a></h1>
<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#concepts">Concepts</a>
<ul>
<li><a href="#execution-result">Execution result</a></li>
<li><a href="#random-access-data">Random access data</a></li>
<li><a href="#reversible-write-reversion">Reversible write reversion</a></li>
<li><a href="#opcode-fetching">Opcode fetching</a></li>
<li><a href="#internal-call">Internal call</a></li>
</ul>
</li>
<li><a href="#constraints">Constraints</a>
<ul>
<li><a href="#main"><code>main</code></a></li>
</ul>
</li>
<li><a href="#implementation">Implementation</a></li>
</ul>
<h1 id="introduction"><a class="header" href="#introduction">Introduction</a></h1>
<p>EVM circuit iterates over transactions included in the proof to verify that each execution step of a transaction is valid. Basically the scale of a step is the same as in the EVM, so usually we handle one opcode per step, except those opcodes like <code>SHA3</code> or <code>CALLDATACOPY</code> that operate on variable size of memory, which would require multiple &quot;virtual&quot; steps.</p>
<blockquote>
<p>The scale of a step somehow could be different depends on the approach, an extreme case is to implement a VM with reduced instruction set (like TinyRAM) to emulate EVM, which would have a much smaller step, but not sure how it compares to current approach.</p>
<p><strong>han</strong></p>
</blockquote>
<p>To verify if a step is valid, we first enumerate all possible execution results of a step in the EVM including success and error cases, and then build a custom constraint to verify that the step transition is correct for each execution result.</p>
<p>For each step, we constrain it to enable one of the execution results, and specially, to constrain the first step to enable <code>BEGIN_TX</code>, which then repeats the step to verify the full execution trace. Also each step is given access to next step to propagate the tracking information, by putting constraints like <code>assert next.program_counter == curr.program_counter + 1</code>.</p>
<h1 id="concepts"><a class="header" href="#concepts">Concepts</a></h1>
<h2 id="execution-result"><a class="header" href="#execution-result">Execution result</a></h2>
<p>It's intuitive to have each opcode as a branch in step. However, EVM has so rich opcodes that some of them are very similar like <code>{ADD,SUB}</code>, <code>{PUSH*}</code>, <code>{DUP*}</code> and <code>{SWAP*}</code> that seem to be handled by almost identical constraint with small tweak (to swap a value or automatically done due to linearity), it seems we could reduce our effort to only implement it once to handle multiple opcodes in single branch.</p>
<p>In addition, an EVM state transition could also contain serveral kinds of error cases, we also need to take them into consideration to be equivalent to EVM. It would be annoying for each opcode branch to handle their own error cases since it needs to halt the step and return the execution context to caller.</p>
<p>Fortunately, most error cases are easy to verify with some pre-built lookup table even they could happen to many opcodes, only some tough errors like out of gas due to dynamic gas usage need to be verified one by one. So we further unroll all kinds of error cases as kinds of execution result.</p>
<p>So we can enumerate <a href="https://github.com/appliedzkp/zkevm-specs/blob/83ad4ed571e3ada7c18a411075574110dfc5ae5a/src/zkevm_specs/evm/execution_result/execution_result.py#L4">all possible execution results</a> and turn EVM circuit into a finite state machine like:</p>
<pre class="mermaid">flowchart LR
    BEGIN[.] --&gt; BeginTx;

    BeginTx --&gt; |no code| EndTx;
    BeginTx --&gt; |has code| EVMExecStates;
    EVMExecStates --&gt; EVMExecStates;
    EVMExecStates --&gt; EndTx;

    EndTx --&gt; BeginTx;

    EndTx --&gt; EndBlock;
    EndBlock --&gt; EndBlock;
    EndBlock --&gt; END[.];
</pre>
<pre class="mermaid">flowchart LR
    subgraph A [EVMExecStates]
    BEGIN2[.] --&gt; SuccessStep;
    BEGIN2[.] --&gt; ReturnStep;
    SuccessStep --&gt; SuccessStep;
    SuccessStep --&gt; ReturnStep;
    ReturnStep --&gt; |not is_root| SuccessStep;
    ReturnStep --&gt; |not is_root| ReturnStep;
    ReturnStep --&gt; |is_root| END2[.];
    end
</pre>
<ul>
<li><strong>BeginTx</strong>:
<ul>
<li>Beginning of a transaction.</li>
</ul>
</li>
<li><strong>EVMExecStates</strong> = [ SuccessStep | ReturnStep ]</li>
<li><strong>SuccessStep</strong> = [ ExecStep | ExecMetaStep | ExecSubStep ]
<ul>
<li>Set of states that suceed and continue the execution within the call.</li>
</ul>
</li>
<li><strong>ReturnStep</strong> = [ ExplicitReturn | Error ]
<ul>
<li>Set of states that halt the execution of a call and return to the caller
or go to the next tx.</li>
</ul>
</li>
<li><strong>ExecStep</strong>:
<ul>
<li>1-1 mapping with a GethExecStep for opcodes that map to a single gadget
with a single step.  Example: <code>ADD</code>, <code>MUL</code>, <code>DIV</code>, <code>CREATE2</code>.</li>
</ul>
</li>
<li><strong>ExecMetaStep</strong>:
<ul>
<li>N-1 mapping with a GethExecStep for opcodes that share the same gadget
(due to similarity) with a single step.  For example <code>{ADD, SUB}</code>,
<code>{PUSH*}</code>, <code>{DUP*}</code> and <code>{SWAP*}</code>.
A good example on how these are grouped is the <code>StackOnlyOpcode</code> struct.</li>
</ul>
</li>
<li><strong>ExecSubStep</strong>:
<ul>
<li>1-N mapping with a GethExecStep for opcodes that deal with dynamic size
arrays for which multiple steps are generated.
<ul>
<li><code>CALLDATACOPY</code> -&gt; CopyToMemory</li>
<li><code>RETURNDATACOPY</code> -&gt; TODO</li>
<li><code>CODECOPY</code> -&gt; TODO</li>
<li><code>EXTCODECOPY</code> -&gt; IN PROGRESS</li>
<li><code>SHA3</code> -&gt; IN PROGRESS</li>
<li><code>LOGN</code> -&gt; CopyToLog</li>
</ul>
</li>
</ul>
</li>
<li><strong>ExplicitReturn</strong>:
<ul>
<li>1-1 mapping with a GethExecStep for opcodes that return from a call
without exception.</li>
</ul>
</li>
<li><strong>Error</strong> = [ ErrorEnoughGas | ErrorOutOfGas ]
<ul>
<li>Set of states that are associated with exceptions caused by opcodes.</li>
</ul>
</li>
<li><strong>ErrorEnoughGas</strong>:
<ul>
<li>Set of error states that are unrelated to out of gas.  Example:
<code>InvalidOpcode</code>, <code>StackOverflow</code>, <code>InvalidJump</code>.</li>
</ul>
</li>
<li><strong>ErrorOutOfGas</strong>:
<ul>
<li>Set of error states for opcodes that run out of gas. For each opcode
(sometimes group of opcodes) that has dynamic memory gas usage, there is
a specific <strong>ErrorOutOfGas</strong> error state.</li>
</ul>
</li>
<li><strong>EndTx</strong>
<ul>
<li>End of a transaction.</li>
</ul>
</li>
<li><strong>EndBlock</strong>
<ul>
<li>End of a block (serves also as padding for the rest of the state step slots)</li>
</ul>
</li>
</ul>
<blockquote>
<p>In the current implementation, we ask the opcode implementer to also implement error cases, which seems to be a redundant effort.
But by doing this, they can focus more on opcode's success case. Also error cases are usually easier to verify, so I think it also reduces the overall implementation complexity.</p>
<p><strong>han</strong></p>
</blockquote>
<h2 id="random-access-data"><a class="header" href="#random-access-data">Random access data</a></h2>
<p>In EVM, the interpreter has the ability to do any random access to data like block context, account balance, stack and memory in current scope, etc... Some of these access are read-write and others are read-only.</p>
<p>In EVM circuit, we leverage the concept <a href="#Circuit-as-a-lookup-table">Circuit as a lookup table</a> to duplicate these random data access to other circuits in a different layout and verify that they are consistent and valid. After these random data access are verified, we can use them just as if they were only tables. <a href="https://github.com/appliedzkp/zkevm-specs/blob/83ad4ed571/src/zkevm_specs/evm/table.py#L108">Here</a> are the tables currently used in the EVM circuit.</p>
<p>For read-write access data, EVM circuit looks up State circuit with a sequentially <code>rw_counter</code> (read-write counter) to make sure the read-write access is chronological. It also uses a flag <code>is_write</code> to check data consistency between different write access.</p>
<p>For read-only access data, EVM circuit looks-up Bytecode circuit, Tx circuit and Call circuit directly.</p>
<h2 id="reversible-write-reversion"><a class="header" href="#reversible-write-reversion">Reversible write reversion</a></h2>
<p>In EVM, reversible writes can be reverted if any call fails. There are many kinds of reversible writes, a complete list can be found <a href="https://github.com/ethereum/go-ethereum/blob/master/core/state/journal.go#L87-L141">here</a>.</p>
<p>In EVM circuit, each call is attached with a flag (<code>is_persistent</code>) to know if it succeeds or not. So ideally, we only need to do reversion on these kinds of reversible writes which affect future execution before reversion:</p>
<ul>
<li><code>TxAccessListAccount</code></li>
<li><code>TxAccessListStorageSlot</code></li>
<li><code>AccountNonce</code></li>
<li><code>AccountBalance</code></li>
<li><code>AccountCodeHash</code></li>
<li><code>AccountStorage</code></li>
</ul>
<p>On some others we don't need to do reversion because they don't affect future execution before reversion, we only write them when <code>is_persistent</code> is <code>1</code>:</p>
<ul>
<li><code>TxRefund</code></li>
<li><code>AccountDestructed</code></li>
</ul>
<blockquote>
<p>Another tag is <code>TxLog</code>, which also doesn't affect future execution. It should be explained where to write such record to after we decide where to build receipt trie.</p>
<p><strong>han</strong></p>
</blockquote>
<p>To enable reversible write reversion, we need some meta information of a call:</p>
<ol>
<li><code>is_persistent</code> - To know if we need reversion or not.</li>
<li><code>rw_counter_end_of_reversion</code> - To know at which point in the future we should revert.</li>
<li><code>reversible_write_counter</code> - To know how many reversible writes we have done until now.</li>
</ol>
<p>Then at each reversible write, we first check if <code>is_persistent</code> is <code>0</code>, if so we do an extra reversible write at <code>rw_counter_end_of_reversion - reversible_write_counter</code> with the old value, which reverts the reversible write in a reverse order.</p>
<p>For more notes on reversible write reversion see:</p>
<ul>
<li><a href="../design/reversible-write-reversion.html">Design Notes, Reversible Write Reversion Note 1</a></li>
<li><a href="../design/reversible-write-reversion2.html">Design Notes, Reversible Write Reversion Note 2</a></li>
</ul>
<h2 id="opcode-fetching"><a class="header" href="#opcode-fetching">Opcode fetching</a></h2>
<p>In EVM circuit, there are 3 kinds of opcode source for execution or copy:</p>
<ol>
<li>Contract interaction:
Opcode is lookup from contract bytecode in Bytecode circuit by tuple <code>(code_hash, index, opcode)</code></li>
<li>Contract creation in root call:
Opcode is lookup from tx calldata in Tx circuit by tuple <code>(tx_id, TxTableTag.Calldata, index, opcode)</code></li>
<li>Contract creation in internal call:
Opcode is lookup from caller's memory in State circuit by tuple <code>(rw_counter, False, caller_id, index, opcode)</code></li>
</ol>
<p>Before we fetch opcode from any source, it checks if the index is in the given range, if not, it follows the behavior of current EVM to implicitly returning <code>0</code>.</p>
<h2 id="internal-call"><a class="header" href="#internal-call">Internal call</a></h2>
<p>EVM supports internal call triggered by opcodes. In EVM circuit, the opcodes (like <code>CALL</code> or <code>CREATE</code>) that trigger internal call, will:</p>
<ul>
<li>Save their own <code>call_state</code> into State circuit.</li>
<li>Setup next call's context.</li>
<li>Initialize next step's <code>call_state</code> to start a new environment.</li>
</ul>
<p>Then the opcodes (like <code>RETURN</code> or <code>REVERT</code>) and error cases that halt, will restore caller's <code>call_state</code> and set it back to next step.</p>
<p>For a simple <code>CALL</code> example with illustration (many details are hided for simplicity):</p>
<p><img src="./evm-circuit_internal-call.png" alt="" /></p>
<h1 id="constraints"><a class="header" href="#constraints">Constraints</a></h1>
<h2 id="main"><a class="header" href="#main"><code>main</code></a></h2>
<p>==TODO== Explain each execution result</p>
<h1 id="implementation"><a class="header" href="#implementation">Implementation</a></h1>
<ul>
<li><a href="https://github.com/appliedzkp/zkevm-specs/blob/master/specs/evm-proof.md">spec</a>
<ul>
<li><a href="https://github.com/appliedzkp/zkevm-specs/tree/master/src/zkevm_specs/evm">python</a></li>
</ul>
</li>
<li><a href="https://github.com/appliedzkp/zkevm-circuits/tree/main/zkevm-circuits/src/evm_circuit">circuit</a></li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../architecture.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../architecture/evm-circuit/opcode-fetching.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../architecture.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../architecture/evm-circuit/opcode-fetching.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript" src="../mermaid.min.js"></script>
        <script type="text/javascript" src="../mermaid-init.js"></script>
    </body>
</html>
